$(document).ready(function(){
	//If there's already a canvas loaded or it's the wrong page, don't load this page
	if($("canvas").size() > 0 || $(".build_orders.new").length == 0){
		return false;
	}

	var sketch = function(p){
		const BRICKS = <%= Global.tower.shipment %>;
		const SHIPMENTSIZE = <%= Global.tower.shipment_size %>

		var USER_ID;
		var tower = [];
		var newBricks = [];
		var finish = false;
		var ar = [];
		var maxLevel = false;

		var background;
		var backgrounds = ["level_one.jpg", "level_two.jpg", "level_three.jpg", "level_four.jpg", "level_five.jpg", "level_six.jpg"];

		//-----------------------------------P5 FUNCTIONS---------------------------------------------
		p.setup = function(){
			canvas = p.createCanvas(p.windowWidth - 550, <%= Global.tower.brick_height %> * <%= Rails.configuration.x.level_height %>);
			canvas.parent("canvas");

			Brick.level = 0;
			loadTower(Brick.level);
			loadOrders(Brick.level, 0);

			var color = Math.floor(Math.random() * 2);
			generateArrangement();
			for(var i = 0; i < ar.length + 1; i++){
				newBricks.push(new Brick(50, 2, p, color, 0));
			}

			$.get('/session.json', function(data){
				USER_ID = data;
			});

			$("#remove").hide();

			background = p.loadImage("../level_one.jpg");
		};

		p.draw = function(){
			//p.background(p.lerpColor(p.color(200), p.color(0), Brick.level/maxLevel));
			p.image(background, 0, 0, background.width, background.height, 0, 0, p.width, p.height);

			//Draws the bricks from the tower
			p.stroke(0);
			p.strokeWeight(1);
			for(var i = 0; i < tower.length; i++){
				tower[i].draw();
			}

			//Draws the player's bricks
			p.stroke(255);
			p.strokeWeight(3);
			for(var i = 0; i < newBricks.length; i++){
				newBricks[i].draw(finish);
			}

			var interval = ((Brick.level - Brick.level % 2) / 2) * 5;
			var requiredStrength = Math.floor(Brick.level/3);

			p.fill(255);
			p.stroke(0);
			if(requiredStrength <= 0){
				p.rect(0, 0, 250, 70);
			}else{
				p.rect(0, 0, 250, 100);
			}
			p.fill(0);
			p.strokeWeight(1);
			p.textSize(20);
			p.text("Level: " + Brick.level, 10, 25);

			if(interval == 0){
				p.text("Update Rate: Immediate", 10, 50);
			}else{
				p.text("Update Rate: " + interval + " minutes", 10, 50);
			}

			if(requiredStrength > 0){
				p.text("Required Strength: " + requiredStrength, 10, 75);
			}

			if(p.mouseY < Brick.BRICK_HEIGHT && !maxLevel){
				p.triangle(p.width/2, 5, p.width/2 - 40, Brick.BRICK_HEIGHT-10, p.width/2 + 40, Brick.BRICK_HEIGHT - 10);
			}else if(p.mouseY > p.height - Brick.BRICK_HEIGHT && Brick.level > 0){
				p.triangle(p.width/2, p.height-5, p.width/2 - 40, p.height - Brick.BRICK_HEIGHT+10, p.width/2 + 40, p.height - Brick.BRICK_HEIGHT + 10);
			}

			if(p.mouseX < Brick.BRICK_WIDTH){
				p.triangle(5, p.height/2, Brick.BRICK_WIDTH-10, p.height/2 - 40, Brick.BRICK_WIDTH - 10, p.height/2 + 40);
			}else if(p.mouseX > p.width - Brick.BRICK_WIDTH){
				p.triangle(p.width - 5, p.height/2, p.width - Brick.BRICK_WIDTH+10, p.height/2 - 40, p.width - Brick.BRICK_WIDTH + 10, p.height/2 + 40);
			}

			if(p.mouseIsPressed){
				if(p.mouseX < Brick.BRICK_WIDTH && p.mouseX > 0 && p.mouseY > p.height/2 - 40 && p.mouseY < p.height/2 + 40){
					Brick.moveLeft();
				}else if(p.mouseX > p.width-Brick.BRICK_WIDTH && p.mouseX < p.width && p.mouseY > p.height/2 - 40 && p.mouseY < p.height/2 + 40){
					Brick.moveRight();
				}
			}
		};

		p.mouseClicked = function(){
			if(p.mouseY < Brick.BRICK_HEIGHT && p.mouseY >= 0 && !maxLevel){
				Brick.level++;
				loadTower(Brick.level);
				loadOrders(Brick.level, 0);
				setBackground(Brick.level);
				updateAlert(Brick.level, finish);
			}else if(p.mouseY > p.height - Brick.BRICK_HEIGHT && p.mouseY < p.height && Brick.level > 0){
				Brick.level--;
				loadTower(Brick.level);
				loadOrders(Brick.level, 0);
				setBackground(Brick.level);
				updateAlert(Brick.level, finish);
			}else if(p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height){
				if(!finish){
					console.log("Brick at " + newBricks[0].x() + ", " + newBricks[0].y() + " level: " + newBricks[0].level());
					finish = true;
					$("#bricks").hide();
					$("#messages").hide();
					updateAlert(Brick.level, finish);
					$("#left").hide();
					$("#right").hide();
					$("#remove").show();
					loadKeyboard(newBricks);
				}else if (withinPlaced(p.mouseX, p.mouseY) && finish){
					moveBricks();
				}
			}
		}

		p.mouseMoved = function(){
			if(p.mouseY < p.height && p.mouseY > 0 && p.mouseX > 0 && p.mouseX < p.width && !finish){
				updateBricks(p.mouseX, p.mouseY);
			}
		};

		p.keyPressed = function(){
			switch(p.keyCode){
				case 65: //A, rotate the bricks
					if(!finish){
						for(var i = 0; i < ar.length; i++){
							var new_ar = [0, 0];
							new_ar[0] = ar[i][1] * -1;
							new_ar[1] = ar[i][0];
							ar[i] = new_ar;
						}
						updateBricks(p.mouseX, p.mouseY);
					}
					break;
				case 68: //D, rotate the bricks
					if(!finish){
						for(var i = 0; i < ar.length; i++){
							var new_ar = [0, 0];
							new_ar[1] = ar[i][0] * -1;
							new_ar[0] = ar[i][1];
							ar[i] = new_ar;
						}
						updateBricks(p.mouseX, p.mouseY);
					}
					break;
				case 83: //S, pick up bricks
					if(finish){
						moveBricks();
						updateBricks(p.mouseX, p.mouseY);
					}
					break;
				case 39: //Right arrow key, move around tower
					Brick.moveRight();
					break;
				case 37: //Left arrow key, move around tower
					Brick.moveLeft();
					break;
				case 38: //Up arrow key, move up a level
					if(!maxLevel){
						Brick.level++;
						loadTower(Brick.level);
						loadOrders(Brick.level, 0);
						setBackground(Brick.level);
						updateAlert(Brick.level, finish);

					}
					break;
				case 40: //Down arrow key, move down a level
					if(Brick.level > 0){
						Brick.level--;
						loadTower(Brick.level);
						loadOrders(Brick.level, 0);
						setBackground(Brick.level);
						updateAlert(Brick.level, finish);
					}
					break;
				default:
					//Do nothing
			}
		};

		//------------------------------------------OTHER FUNCTIONS------------------------------------
				
		//Generates the arrangement of bricks. Kind of hacky.
		function generateArrangement(){
			for(var i = 0; i < SHIPMENTSIZE-1; i++){
				ar[i] = []
				for(var j = 0; j < 2; j++){
					ar[i][j] = Math.floor(Math.random()*3-1);
				}
			}
			//Don't put a new brick on top of my old brick!
			if(ar[0][0] == 0 && ar[0][1] == 0){
				ar[0][0] = 1;
			}
			if(ar[1][0] == 0 && ar[1][1] == 0){
				ar[1][0] = -1;
			}
			//If the first and second brick are in the same place
			//Throw away one of them
			if(ar[0][0] == ar[1][0] && ar[0][1] == ar[1][1]){
				ar.shift();
			}
		}

		//Is the given screen coordinates inside the new bricks?
		function withinPlaced(x, y){
			for(var i = 0; i < newBricks.length; i++){
				if(newBricks[i].isWithin(x, y)){
					return true;
				}
			}
			return false;
		}

		//Takes the new bricks and moves them to the given coordinates
		function updateBricks(x, y){
			if(!Brick.withinTower(x, 0) || !Brick.onLevel(y, 0)){
				return false;
			}
			for(var i = 0; i < ar.length; i++){
				if(!Brick.withinTower(x, ar[i][0]) || !Brick.onLevel(y, ar[i][1])){
					return false;
				}
			}
			newBricks[0].update(x, y, 0, 0);
			for(var i = 0; i < ar.length; i++){
				newBricks[i+1].update(x, y, ar[i][0], ar[i][1]);
			}
		}

		//Removes the keyboard and lets you move the bricks again
		function moveBricks(){
			finish = false;

			$("#remove").hide();

			$("#bricks").show();
			$("#messages").show();
			$("#left").show();
			$("#right").show();

			$("#message_form").remove();
			updateAlert(Brick.level, finish);
		}

		//Loads the tower from the server
		function loadTower(requestedLevel){
			tower = [];
			$.get('/tower/'+requestedLevel + '.json', {level: requestedLevel}, function(data){
				if(data.length == 0){
					maxLevel = true;
				}else{
					maxLevel = false;
					for(var i = 0; i < data.length; i++){
						tower.push(new Brick(data[i]["x"], data[i]["y"], p, data[i]["color"], data[i]["strength"]));
					}
				}
			});
		}

		//Sets the new background
		function setBackground(level){
			var index = Math.min(level, backgrounds.length - 1);
			background = p.loadImage("../" + backgrounds[index]);
		}

		//I'm going to be doing a lot of this, so I should come up with a better way to do this sort of thing
		function updateAlert(level, placed){
			if(level < 2){
				if(placed){
					$("#instructions").html("Press submit to add your brick to the tower!");
				}else{
					$("#instructions").html("Place your bricks on the tower to build it higher! Overlap bricks of the same color to make them stronger but overlapping different colors will make them weaker or destroy them! You can see how strong a brick is based on how many lines it has on it. Bricks without support will fall down and be destroyed!");
				}
			}else if(level == 2){
				if(placed){
					$("#instructions").html("You and all other builder's bricks will be added to the tower " + nextTime(level) +". Write a message to tell other builders where you've placed your bricks. Click on the glyphs below to write your message. Click on glyphs in the message to delete them. From now on, all bricks must have messages!");
				}else{
					$("#instructions").html("The tower is so high that it now takes time to build! All bricks placed on this level will be placed every five minutes, all at once.");
				}
			}else if(level == 3){
				if(!placed){
					$("#instructions").html("At this height, heavy winds will destroy any bricks which don't have at least one strength. Use the messages to communicate where you're putting bricks with other builders and overlap bricks of the same color.");
				}else{
					$("#instructions").html("Use your message to help other builders strengthen your bricks and survive the winds! All bricks will be added to the tower " + nextTime(level) +".");
				}
			}else if(level == 4){
				if(!placed){
					$("#instructions").html("The higher the tower gets, the longer is takes to build. Orders are now resolved every 10 minutes.");
				}else{
					$("#instructions").html("Use your message to help other builders strengthen your bricks and survive the winds! All bricks will be added to the tower " + nextTime(level) +".");
				}
			}else{
				if(!placed){
					$("#instructions").html("Keep building the tower!");
				}else{
					$("#instructions").html("All bricks will be added to the tower " + nextTime(level) +".");
				}
			}
		}

		//-------------------------------------------------------------------------------------------------
		//------------------------------------------------JQUERY EVENT HANDLERS----------------------------
		//-------------------------------------------------------------------------------------------------
		
		// $(document).on('click', '#up', function(){
			
		// });

		// $(document).on('click', '#down', function(){
			
		// });
	};

	var myp5 = new p5(sketch);
});